<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>영어 단어 학습 (JSON 기반)</title>

<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; padding:24px; }
h1 { text-align:center; }
select, button {
  padding:10px 12px; margin:4px;
  border-radius:8px; border:1px solid #ccc;
}
button.primary { background:#111; color:#fff; }
button.danger { background:#b00020; color:#fff; }
.card {
  max-width:720px; margin:16px auto; background:#fff;
  padding:18px; border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
}
.word { font-size:34px; text-align:center; font-weight:700; }
.sub { text-align:center; color:#666; }
.example em { font-weight:700; }
.hidden { display:none; }
.tabs { display:flex; justify-content:center; gap:8px; margin:12px 0; }
.tab { padding:8px 12px; border:1px solid #ccc; border-radius:999px; cursor:pointer; }
.tab.active { background:#111; color:#fff; }
.choices { display:grid; gap:10px; }
.choice { padding:10px; border:1px solid #ccc; border-radius:8px; cursor:pointer; }
.choice.correct { background:#e8f5e9; border-color:#1b5e20; }
.choice.wrong { background:#ffebee; border-color:#b00020; }
.stats { display:flex; gap:8px; justify-content:center; font-size:14px; color:#666; }
</style>
</head>

<body>

<h1>영어 단어 학습 (JSON 기반)</h1>

<div style="text-align:center;">
  <select id="gradeSelect">
    <option value="">학년 선택</option>
    <option value="elem_low">초등 저학년</option>
    <option value="elem_high">초등 고학년</option>
    <option value="middle_1">중1</option>
    <option value="middle_2">중2</option>
    <option value="middle_3">중3</option>
    <option value="high_1">고1</option>
    <option value="high_2">고2</option>
    <option value="high_3">고3</option>
    <option value="csat_core">수능 필수</option>
  </select>

  <select id="difficultySelect">
    <option value="">난이도</option>
    <option value="B1">B1</option>
    <option value="B2">B2</option>
    <option value="C1">C1</option>
  </select>

  <button class="primary" onclick="startStudy()">시작</button>
  <button class="danger" onclick="clearProgress()">초기화</button>
</div>

<div class="tabs hidden" id="tabs">
  <div class="tab active" onclick="setStep(1)">Step1 단어</div>
  <div class="tab" onclick="setStep(2)">Step2 예문</div>
  <div class="tab" onclick="setStep(3)">Step3 퀴즈</div>
  <div class="tab" onclick="setStep(4)">Step4 오답</div>
</div>

<div class="card hidden" id="card">

  <div class="stats">
    <div id="stat1"></div>
    <div id="stat2"></div>
    <div id="stat3"></div>
  </div>

  <!-- Step1/2 -->
  <div id="studyBox">
    <div class="word" id="word"></div>
    <div class="sub" id="meaning"></div>
    <div class="example" id="example"></div>

    <div style="text-align:center; margin-top:12px;">
      <button onclick="prevWord()">이전</button>
      <button class="primary" onclick="nextWord()">다음</button>
    </div>
  </div>

  <!-- Step3 -->
  <div id="quizBox" class="hidden">
    <div class="word" id="quizQ"></div>
    <div class="choices" id="choices"></div>
  </div>

  <!-- Step4 -->
  <div id="wrongBox" class="hidden">
    <div class="word">오답노트</div>
    <div class="sub" id="wrongList"></div>
  </div>

</div>

<script>
const SESSION_SIZE = 30;
const STORAGE_KEY = "english_vocab_progress";

let all = [], filtered = [], session = [];
let step = 1, sessionIndex = 0, wordIndex = 0;
let wrong = new Map();

/* ---------- 시작 ---------- */
async function startStudy(resume=false){
  const grade = resume ? loadProgress().grade : gradeSelect.value;
  const diff = resume ? loadProgress().difficulty : difficultySelect.value;
  if(!grade||!diff) return alert("학년/난이도 선택");

  const res = await fetch(`data/${grade}.json`);
  all = await res.json();
  filtered = all.filter(x=>x.difficulty===diff);

  sessionIndex = resume ? loadProgress().sessionIndex : 0;
  wordIndex = resume ? loadProgress().wordIndex : 0;

  loadSession();
  tabs.classList.remove("hidden");
  card.classList.remove("hidden");
}

function loadSession(){
  session = filtered.slice(
    sessionIndex*SESSION_SIZE,
    sessionIndex*SESSION_SIZE+SESSION_SIZE
  );
  showWord();
  updateStats();
}

function showWord(){
  const w = session[wordIndex];
  word.innerText = w.word;
  meaning.innerText = w.meaning;
  example.innerHTML = step===2 ? w.example.replace(w.word, `<em>${w.word}</em>`) : "";
  saveProgress();
}

function nextWord(){ wordIndex=(wordIndex+1)%session.length; showWord(); }
function prevWord(){ wordIndex=(wordIndex-1+session.length)%session.length; showWord(); }

/* ---------- Step ---------- */
function setStep(n){
  step=n;
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tab")[n-1].classList.add("active");
  studyBox.style.display = n<=2?"block":"none";
  quizBox.classList.toggle("hidden", n!==3);
  wrongBox.classList.toggle("hidden", n!==4);
  if(n===3) buildQuiz();
  if(n===4) renderWrong();
}

/* ---------- Quiz ---------- */
function buildQuiz(){
  const t = session[wordIndex];
  quizQ.innerText = `뜻: ${t.meaning}`;
  const opts = shuffle([t,...pickRandom(filtered,3,new Set([t.word]))]);
  choices.innerHTML="";
  opts.forEach(o=>{
    const d=document.createElement("div");
    d.className="choice";
    d.innerText=o.word;
    d.onclick=()=>{
      if(o.word===t.word) d.classList.add("correct");
      else { d.classList.add("wrong"); wrong.set(t.word,t); }
      updateStats();
    };
    choices.appendChild(d);
  });
}

/* ---------- Wrong ---------- */
function renderWrong(){
  wrongList.innerText = wrong.size
    ? [...wrong.keys()].join(", ")
    : "오답 없음";
}

/* ---------- Utils ---------- */
function shuffle(a){ return a.sort(()=>Math.random()-0.5); }
function pickRandom(a,n,ex){
  return a.filter(x=>!ex.has(x.word)).slice(0,n);
}

/* ---------- Stats / Save ---------- */
function updateStats(){
  stat1.innerText=`회차 ${sessionIndex+1}`;
  stat2.innerText=`단어 ${wordIndex+1}/${session.length}`;
  stat3.innerText=`오답 ${wrong.size}`;
}

function saveProgress(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    grade:gradeSelect.value,
    difficulty:difficultySelect.value,
    sessionIndex, wordIndex
  }));
}
function loadProgress(){ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }
function clearProgress(){
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
}

window.onload=()=>{
  if(localStorage.getItem(STORAGE_KEY)){
    if(confirm("이어서 학습할까요?")) startStudy(true);
  }
};
</script>

</body>
</html>
